<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è·å ´æœå‹™å¤§æŒ‘æˆ° (ç©ºæœå“¡) - å–®æ©Ÿç‰ˆ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { font-family: 'Inter', system-ui, sans-serif; }
    body { overflow: hidden; user-select: none; }

    /* âœ… æ‰‹æ©Ÿé«˜åº¦é—œéµï¼šç”¨ 100dvh é¿å…è¢«ç¶²å€åˆ—åƒé«˜åº¦ */
    .app-dvh { height: 100dvh; }

    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    .shake-hard { animation: shake 0.5s infinite; }
    .shake-soft { animation: shake 0.5s; }

    @keyframes popIn {
      0% { transform: scale(0); opacity: 0; }
      80% { transform: scale(1.1); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .event-card {
      animation: popIn 0.28s ease-out forwards;
      position: absolute;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      max-width: 300px;
      z-index: 10;
    }
    .event-card.selected {
      z-index: 50 !important;
      transform: scale(1.15) !important;
      border: 4px solid #3b82f6;
      box-shadow: 0 0 30px rgba(59, 130, 246, 0.6);
    }

    .btn-action {
      transition: transform 0.1s;
      box-shadow: 0 6px 0 rgba(0,0,0,0.2);
    }
    .btn-action:active { transform: translateY(6px); box-shadow: 0 0 0 rgba(0,0,0,0.2); }
    .btn-action:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    .fade-in-text { opacity: 0; transition: opacity 0.9s ease-in; }
    .visible { opacity: 1; }

    /* ===== Dashboard sizes ===== */
    .dash-card { padding: 0.75rem; }
    .dash-number { font-size: 2.6rem; line-height: 1; }
    .dash-label { font-size: 0.75rem; }

    @media (min-width: 640px) {
      .dash-number { font-size: 3.1rem; }
      .dash-card { padding: 1rem; }
    }

    /* ===== Controls: always visible ===== */
    .controls-wrap { min-height: 86px; }
    .controls-title { font-size: 1.35rem; line-height: 1.05; font-weight: 900; }
    .controls-meta  { font-size: 0.9rem; line-height: 1.1; font-weight: 800; opacity: 0.95; }
    .fatigue-track { height: 7px; border-radius: 999px; background: rgba(255,255,255,0.22); }
    .fatigue-bar { height: 7px; border-radius: 999px; background: rgba(255,255,255,0.95); }

    /* âœ… æ‰‹æ©Ÿ/å¹³æ¿ï¼šæ§åˆ¶å€è²¼åº• + safe-areaï¼Œçµ•ä¸è¢«è£åˆ‡ */
    .mobile-sticky {
      position: sticky;
      bottom: 0;
      z-index: 40;
      padding-bottom: env(safe-area-inset-bottom);
      background: linear-gradient(to top, rgba(2,6,23,0.95), rgba(2,6,23,0.65), rgba(2,6,23,0));
      backdrop-filter: blur(6px);
    }

    /* fatigue æç¤ºå›ºå®šå¯è¦‹ï¼Œä¸ä½”å¤ªå¤šé«˜åº¦ */
    #fatigue-msg {
      min-height: 1.25rem;
      font-weight: 900;
      letter-spacing: 0.2px;
    }

    @media (max-width: 640px) {
      .controls-title { font-size: 1.18rem; }
      .controls-meta { font-size: 0.82rem; }
      .fatigue-track, .fatigue-bar { height: 6px; }
    }
  </style>
</head>

<body class="bg-slate-900 text-white min-h-screen flex flex-col">

  <!-- Start -->
  <div id="start-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 transition-opacity duration-500">
    <h1 class="text-5xl sm:text-6xl font-black text-yellow-400 mb-3 tracking-wider">è·å ´æœå‹™å¤§æŒ‘æˆ°</h1>
    <h2 class="text-2xl sm:text-3xl text-white mb-8">ç©ºæœå“¡ 60ç§’æš´èµ°å¯¦æ¸¬</h2>
    <div class="bg-slate-800 p-6 sm:p-8 rounded-2xl shadow-2xl text-center border border-slate-700 max-w-2xl">
      <p class="text-gray-400 mb-6 text-base sm:text-lg">
        è¦å‰‡ï¼š<span class="text-white font-bold">é»é¸äº‹ä»¶å¡</span> â†’ æŒ‰ä¸‹æ–¹æŒ‰éˆ•è™•ç†ã€‚<br>
        ä½ ä¸æœƒã€ŒåšéŒ¯ã€ï¼Œä½†ä½ å¯èƒ½æœƒã€Œæ’ä¸ä½ã€ã€‚
      </p>
      <button onclick="startCountdown()" class="bg-blue-600 hover:bg-blue-500 text-white text-3xl sm:text-4xl font-bold py-5 sm:py-6 px-14 sm:px-20 rounded-full shadow-lg transition transform hover:scale-105">
        é–‹å§‹æŒ‘æˆ°
      </button>
    </div>
  </div>

  <!-- Countdown -->
  <div id="countdown-overlay" class="hidden fixed inset-0 z-[60] bg-black/90 flex items-center justify-center">
    <span id="countdown-number" class="text-9xl font-black text-white">3</span>
  </div>

  <!-- Game -->
  <div id="game-screen" class="hidden flex-col w-full max-w-7xl mx-auto p-3 sm:p-4 app-dvh">

    <!-- Dashboard (two rows, stress full width) -->
    <div class="bg-slate-800/50 rounded-xl border border-slate-700 dash-card mb-3 sm:mb-4">
      <div class="flex items-end justify-between gap-3">
        <div class="text-center w-28 sm:w-32">
          <div class="dash-label text-gray-400 font-bold">å‰©é¤˜æ™‚é–“</div>
          <div id="timer" class="dash-number font-black text-white tabular-nums">60</div>
        </div>

        <div class="text-center w-36 sm:w-44">
          <div class="dash-label text-gray-400 font-bold">é¡§å®¢æ»¿æ„åº¦</div>
          <div class="flex items-center justify-center gap-2">
            <span id="sat-icon" class="text-3xl sm:text-4xl">ğŸ˜</span>
            <span id="sat-val" class="text-4xl sm:text-5xl font-black text-blue-400 tabular-nums">70</span>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <div class="flex justify-between mb-1">
          <span class="text-xs sm:text-sm font-bold text-red-400">æƒ…ç·’å£“åŠ›</span>
          <span id="stress-val" class="text-xs sm:text-sm font-bold text-red-400">20%</span>
        </div>
        <div class="h-7 sm:h-8 bg-slate-700 rounded-full overflow-hidden border border-slate-600 relative w-full">
          <div id="stress-bar" class="h-full bg-gradient-to-r from-green-500 via-yellow-500 to-red-600 transition-all duration-250" style="width: 20%;"></div>
        </div>
      </div>
    </div>

    <!-- Events -->
    <div id="event-area" class="relative flex-1 bg-slate-800/30 rounded-2xl border-2 border-dashed border-slate-600 mb-2 sm:mb-3 overflow-hidden">
      <div id="empty-msg" class="absolute inset-0 flex items-center justify-center text-slate-600 text-lg sm:text-xl font-bold pointer-events-none">
        ç­‰å¾…äº‹ä»¶ç™¼ç”Ÿ...
      </div>
    </div>

    <!-- Sticky control area (always visible on mobile) -->
    <div class="mobile-sticky pt-2">
      <div id="fatigue-msg" class="text-center text-orange-300 mb-2"></div>

      <div class="grid grid-cols-3 gap-3 sm:gap-6 controls-wrap">
        <button id="btn-soothe" onclick="handleAction('soothe')" class="btn-action bg-green-600 hover:bg-green-500 text-white rounded-xl flex flex-col items-center justify-center relative px-3 py-3 sm:py-4">
          <div class="controls-title">å®‰æ’«</div>
          <div class="controls-meta" id="meta-soothe">æ•ˆæœ 100%</div>
          <div class="absolute left-3 right-3 bottom-2 fatigue-track"></div>
          <div class="absolute left-3 bottom-2 fatigue-bar" id="bar-soothe" style="width:100%"></div>
        </button>

        <button id="btn-explain" onclick="handleAction('explain')" class="btn-action bg-yellow-600 hover:bg-yellow-500 text-white rounded-xl flex flex-col items-center justify-center relative px-3 py-3 sm:py-4">
          <div class="controls-title">èªªæ˜</div>
          <div class="controls-meta" id="meta-explain">æ•ˆæœ 100%</div>
          <div class="absolute left-3 right-3 bottom-2 fatigue-track"></div>
          <div class="absolute left-3 bottom-2 fatigue-bar" id="bar-explain" style="width:100%"></div>
        </button>

        <button id="btn-act" onclick="handleAction('act')" class="btn-action bg-red-600 hover:bg-red-500 text-white rounded-xl flex flex-col items-center justify-center relative px-3 py-3 sm:py-4">
          <div class="controls-title">è¡Œå‹•</div>
          <div class="controls-meta" id="meta-act">æ•ˆæœ 100%</div>
          <div class="absolute left-3 right-3 bottom-2 fatigue-track"></div>
          <div class="absolute left-3 bottom-2 fatigue-bar" id="bar-act" style="width:100%"></div>
        </button>
      </div>
    </div>

  </div>

  <!-- Result -->
  <div id="result-screen" class="hidden fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-6 sm:p-8 overflow-y-auto">
    <h2 class="text-4xl sm:text-5xl font-black text-red-500 mb-8 tracking-widest uppercase border-b-4 border-red-500 pb-2">æŒ‘æˆ°çµæŸ</h2>

    <div class="text-center mb-10 space-y-4 max-w-3xl">
      <p id="final-remark-1" class="text-xl sm:text-2xl text-white font-light fade-in-text"></p>
      <p id="final-remark-2" class="text-xl sm:text-2xl text-white font-light fade-in-text"></p>
    </div>

    <div class="flex flex-col sm:flex-row gap-6 sm:gap-8 mb-10 w-full max-w-4xl">
      <div class="flex-1 bg-gray-900 p-6 rounded-xl border border-gray-800 text-center">
        <div class="text-gray-400 text-sm uppercase">ç¸½åˆ†</div>
        <div id="final-score" class="text-6xl font-black text-yellow-400">0</div>
      </div>
      <div class="flex-1 bg-gray-900 p-6 rounded-xl border border-gray-800 text-center space-y-2">
        <div class="flex justify-between border-b border-gray-800 pb-2">
          <span class="text-gray-400">é¡§å®¢æ»¿æ„åº¦</span>
          <span id="final-sat" class="text-blue-400 font-bold">0</span>
        </div>
        <div class="flex justify-between border-b border-gray-800 pb-2">
          <span class="text-gray-400">æƒ…ç·’å£“åŠ›</span>
          <span id="final-stress" class="text-red-400 font-bold">0</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400">è§£æ±ºäº‹ä»¶æ•¸</span>
          <span id="final-resolve" class="text-green-400 font-bold">0</span>
        </div>
      </div>
    </div>

    <div class="w-full max-w-2xl bg-gray-900 rounded-xl p-6 border border-gray-700 mb-8">
      <h3 class="text-xl text-yellow-400 font-bold mb-4 flex justify-between items-center">
        <span>ğŸ† ç¾å ´è‹±é›„æ¦œ (Top 5)</span>
        <button onclick="customConfirm('ç¢ºå®šè¦æ¸…ç©ºæ’è¡Œæ¦œå—ï¼Ÿ', () => clearLeaderboard())" class="text-xs text-gray-600 hover:text-red-500 underline">æ¸…ç©ºç´€éŒ„</button>
      </h3>

      <div class="flex gap-2 mb-4">
        <input type="text" id="player-name" placeholder="è¼¸å…¥æš±ç¨±..." class="flex-1 bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500" maxlength="10">
        <button id="btn-save" onclick="saveScore()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-bold">ç™»è¨˜</button>
      </div>

      <table class="w-full text-left">
        <thead>
          <tr class="text-gray-500 text-sm border-b border-gray-800">
            <th class="pb-2">#</th>
            <th class="pb-2">å§“å/éšŠä¼</th>
            <th class="pb-2 text-right">åˆ†æ•¸</th>
            <th class="pb-2 text-right">å£“åŠ›</th>
          </tr>
        </thead>
        <tbody id="leaderboard-body"></tbody>
      </table>
    </div>

    <button onclick="location.reload()" class="text-gray-400 hover:text-white border border-gray-600 hover:border-white px-8 py-3 rounded-full transition">
      ä¸‹ä¸€ä½æŒ‘æˆ°è€… (é‡æ–°é–‹å§‹)
    </button>
  </div>

<script>
  const GAME_DURATION = 60;
  const MAX_EVENTS_ON_SCREEN = 6;

  const EVENTS = [
    { id: 'angry',   emoji: 'ğŸ˜ ', title: 'æ†¤æ€’å®¢è¨´',       prompt: 'æˆ‘è¦è¦‹ä½ å€‘ä¸»ç®¡ï¼',             type: 'soothe',  color: 'bg-red-500' },
    { id: 'crying',  emoji: 'ğŸ˜¢', title: 'æƒ…ç·’å´©æ½°',       prompt: 'æˆ‘çœŸçš„å¿«æ’ä¸ä½äº†â€¦',           type: 'soothe',  color: 'bg-indigo-500' },
    { id: 'panic',   emoji: 'ğŸ˜±', title: 'ææ…Œç™¼ä½œ',       prompt: 'æˆ‘å‘¼å¸ä¸åˆ°â€¦æˆ‘å¥½æ€•ï¼',         type: 'soothe',  color: 'bg-fuchsia-600' },
    { id: 'rude',    emoji: 'ğŸ˜¤', title: 'å«Œä½ è‡‰å¤ªè‡­',     prompt: 'ä½ å¯ä»¥ä¸è¦é‚£éº¼ä¸è€ç…©å—ï¼Ÿ',     type: 'soothe',  color: 'bg-rose-600' },
    { id: 'gender',  emoji: 'ğŸ™…â€â™€ï¸', title: 'æŒ‡å®šå¥³æ€§ç©ºæœå“¡', prompt: 'æˆ‘è¦å¥³ç”Ÿä¾†æœå‹™ï¼ä½ ä¸è¡Œã€‚',     type: 'soothe',  color: 'bg-pink-600' },
    { id: 'baby',    emoji: 'ğŸ‘¶', title: 'å¬°å…’å“­é¬§',       prompt: 'å“‡å•Šå•Šå•Šï¼ï¼ï¼',               type: 'soothe',  color: 'bg-pink-500' },

    { id: 'anxiety', emoji: 'ğŸ˜°', title: 'æ™‚é–“ç„¦æ…®',       prompt: 'è½‰æ©Ÿè¦ä¾†ä¸åŠäº†ï¼',             type: 'explain', color: 'bg-orange-500' },
    { id: 'seat',    emoji: 'ğŸ’º', title: 'è¦æ±‚æ›åº§ä½',     prompt: 'æˆ‘ä¸æƒ³åé€™è£¡ï¼Œå¹«æˆ‘æ›ï¼',       type: 'explain', color: 'bg-teal-600' },
    { id: 'narrow',  emoji: 'ğŸ“', title: 'åº§ä½å¤ªç‹¹çª„',     prompt: 'é€™ä¹Ÿå¤ªæ“ äº†å§ï¼Ÿ',               type: 'explain', color: 'bg-cyan-700' },
    { id: 'fat',     emoji: 'ğŸ˜«', title: 'éš”å£å¤ªæ“ ',       prompt: 'éš”å£ä¸€ç›´æ“ åˆ°æˆ‘ï¼',             type: 'explain', color: 'bg-sky-700' },
    { id: 'mealbad', emoji: 'ğŸ±', title: 'é¤é»ä¸å¥½åƒ',     prompt: 'é€™å€‹ä¹Ÿå¤ªé›£åƒäº†å§ï¼Ÿ',           type: 'explain', color: 'bg-amber-700' },
    { id: 'vip',     emoji: 'ğŸ‘‘', title: 'å‡è‰™è¦æ±‚',       prompt: 'æˆ‘æ˜¯é«˜å¡æœƒå“¡ï¼Œæ‡‰è©²è¦å‡è‰™ã€‚',     type: 'explain', color: 'bg-purple-600' },

    { id: 'spill',   emoji: 'ğŸ¥¤', title: 'æ‰“ç¿»é£²æ–™',       prompt: 'å’–å•¡ç‘åœ¨æˆ‘èº«ä¸Šäº†ï¼',           type: 'act',     color: 'bg-amber-800' },
    { id: 'sick',    emoji: 'ğŸ¤¢', title: 'èº«é«”ä¸é©',       prompt: 'æˆ‘é ­å¥½æšˆâ€¦æƒ³åã€‚',             type: 'act',     color: 'bg-lime-700' },
    { id: 'blanket', emoji: 'ğŸ§£', title: 'å¤ªå†·è¦æ¯›æ¯¯',     prompt: 'æˆ‘å¿«å†·æ­»äº†ï¼Œå¿«çµ¦æˆ‘æ¯¯å­ã€‚',     type: 'act',     color: 'bg-blue-600' },
    { id: 'wifi',    emoji: 'ğŸ“¶', title: 'Wi-Fi ä¸èƒ½ç”¨',   prompt: 'ç¶²è·¯é€£ä¸ä¸Šï¼Œä½ å€‘åœ¨å¹¹å˜›ï¼Ÿ',     type: 'act',     color: 'bg-slate-600' },
    { id: 'toilet',  emoji: 'ğŸš»', title: 'å»æ‰€æ’éšŠçˆ†æ»¿',   prompt: 'æˆ‘å¿«æ†‹ä¸ä½äº†ï¼',               type: 'act',     color: 'bg-emerald-700' },
    { id: 'headset', emoji: 'ğŸ§', title: 'è€³æ©Ÿå£äº†',       prompt: 'è€³æ©Ÿæ²’è²éŸ³ï¼Œå¹«æˆ‘è™•ç†ã€‚',       type: 'act',     color: 'bg-violet-700' }
  ];
  const EVENT_BY_ID = Object.fromEntries(EVENTS.map(e => [e.id, e]));

  const IMPACTS = {
    soothe:  { soothe: [ 14, -10], explain: [  6,  -6], act: [  4,   0] },
    explain: { soothe: [ -6,   6], explain: [ 11,  -6], act: [  1,   4] },
    act:     { soothe: [ -6,  10], explain: [  2,   4], act: [ 14,  -5] }
  };

  const FINAL_REMARKS = [
    { r1: "ã€Œä½ åšçš„ä¸æ˜¯ã€å°ä¸å°ã€ï¼Œè€Œæ˜¯ã€èƒ½ä¸èƒ½ç©©ä½è‡ªå·±ã€ã€‚ã€", r2: "ã€Œæƒ…ç·’ä¸æ˜¯æ•µäººï¼Œæ˜¯è¨Šè™Ÿï¼šå…ˆè½è¦‹ï¼Œå†å›æ‡‰ã€‚ã€" },
    { r1: "ã€Œå£“åŠ›ä¸€é«˜ï¼Œæœ€å…ˆå¤±çœŸçš„é€šå¸¸ä¸æ˜¯è‹±æ–‡ï¼Œæ˜¯èªæ°£èˆ‡åˆ¤æ–·ã€‚ã€", r2: "ã€Œä½ èƒ½åšçš„ï¼Œæ˜¯æŠŠæƒ…ç·’è½‰æˆå¯åˆä½œçš„è¨Šæ¯ã€‚ã€" },
    { r1: "ã€Œä½ ä¸æ˜¯ä¸åŠªåŠ›ï¼Œè€Œæ˜¯è³‡æºæœ‰é™ï¼šæ³¨æ„åŠ›ã€æ™‚é–“ã€è€å¿ƒæœƒå¿«é€Ÿè€—ç›¡ã€‚ã€", r2: "ã€Œé©åº¦è½‰æ›ç­–ç•¥ï¼Œæ‰æ˜¯è‡ªæˆ‘èª¿ç¯€çš„é–‹å§‹ã€‚ã€" },
    { r1: "ã€ŒåŒç†ä¸æ˜¯é †å¾ï¼šå…ˆæ‰¿æ¥æ„Ÿå—ï¼Œå†æ¸…æ¥šèªªç•Œç·šã€‚ã€", r2: "ã€Œç©©å®šçš„å›æ‡‰ï¼Œæ¯”è¯éº—çš„å¥å‹æ›´å°ˆæ¥­ã€‚ã€" },
    { r1: "ã€Œä½ æ’ä½çš„ç¬é–“ï¼Œå°±æ˜¯ã€è·å ´ç´ é¤Šã€è¢«çœ‹è¦‹çš„ç¬é–“ã€‚ã€", r2: "ã€Œä¸‹ä¸€æ¬¡ï¼šæ›´æ—©è¦ºå¯Ÿã€æ›´å¿«é™å£“ã€æ›´æ¸…æ¥šæ±ºç­–ã€‚ã€" }
  ];

  const CHAIN_RULES = {
    gender: { onSpawn: [{ id: 'rude', p: 0.55, delayMs: [650, 1100] }, { id: 'angry', p: 0.25, delayMs: [800, 1200] }],
              onResolve: [{ id: 'angry', p: 0.20, delayMs: [650, 1100] }] },
    fat: { onResolve: [{ id: 'seat', p: 0.55, delayMs: [650, 1100] }] },
    narrow: { onResolve: [{ id: 'seat', p: 0.45, delayMs: [650, 1100] }] },
    seat: { onResolve: [{ id: 'anxiety', p: 0.35, delayMs: [650, 1050] }] },
    mealbad: { onResolve: [{ id: 'angry', p: 0.45, delayMs: [650, 1100] }] },
    wifi: { onResolve: [{ id: 'rude', p: 0.35, delayMs: [650, 1100] }] },
    spill: { onResolve: [{ id: 'angry', p: 0.35, delayMs: [650, 1100] }] },
    sick: { onResolve: [{ id: 'panic', p: 0.30, delayMs: [650, 1100] }] },
    baby: { onResolve: [{ id: 'rude', p: 0.28, delayMs: [650, 1100] }] }
  };

  let state = {
    time: GAME_DURATION,
    satisfaction: 70,
    stress: 20,
    resolveCount: 0,
    activeEvents: [],
    selectedEventId: null,
    fatigue: { soothe: 0, explain: 0, act: 0 },
    isPlaying: false,
    timerInterval: null,
    spawnerInterval: null,
    neglectInterval: null,
    currentSpawnMs: null
  };

  const els = {
    timer: document.getElementById('timer'),
    stressBar: document.getElementById('stress-bar'),
    stressVal: document.getElementById('stress-val'),
    satVal: document.getElementById('sat-val'),
    satIcon: document.getElementById('sat-icon'),
    eventArea: document.getElementById('event-area'),
    emptyMsg: document.getElementById('empty-msg'),
    fatigueMsg: document.getElementById('fatigue-msg'),
    meta: {
      soothe: document.getElementById('meta-soothe'),
      explain: document.getElementById('meta-explain'),
      act: document.getElementById('meta-act')
    },
    bars: {
      soothe: document.getElementById('bar-soothe'),
      explain: document.getElementById('bar-explain'),
      act: document.getElementById('bar-act')
    },
    btns: {
      soothe: document.getElementById('btn-soothe'),
      explain: document.getElementById('btn-explain'),
      act: document.getElementById('btn-act')
    }
  };

  function randInt(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }

  function startCountdown() {
    document.getElementById('start-screen').classList.add('hidden');
    document.getElementById('countdown-overlay').classList.remove('hidden');

    let count = 3;
    const countEl = document.getElementById('countdown-number');

    const cInt = setInterval(() => {
      count--;
      if (count > 0) countEl.innerText = count;
      else {
        clearInterval(cInt);
        document.getElementById('countdown-overlay').classList.add('hidden');
        startGame();
      }
    }, 1000);
  }

  function startGame() {
    document.getElementById('game-screen').classList.remove('hidden');
    document.getElementById('game-screen').classList.add('flex');

    state.isPlaying = true;
    updateButtonsState(false);
    updateUI();
    updateFatigueUI(true);

    state.timerInterval = setInterval(() => {
      state.time--;
      updateUI();
      updateDifficulty();
      if (state.time <= 0) endGame();
    }, 1000);

    setSpawner(2200);

    state.neglectInterval = setInterval(() => {
      if (state.activeEvents.length > 0) {
        const satPenalty = state.activeEvents.length * 2.0;
        const stressPenalty = state.activeEvents.length * 1.0;

        state.satisfaction = Math.max(0, state.satisfaction - satPenalty);
        state.stress = Math.min(100, state.stress + stressPenalty);

        els.stressVal.classList.add('shake-soft');
        setTimeout(() => els.stressVal.classList.remove('shake-soft'), 180);

        updateUI();
      }
    }, 1000);
  }

  function updateDifficulty() {
    if (!state.isPlaying) return;
    const elapsed = GAME_DURATION - state.time;
    let newInterval;

    if (elapsed < 10) newInterval = 2200;
    else if (elapsed < 20) newInterval = 1700;
    else if (elapsed < 30) newInterval = 1250;
    else if (elapsed < 40) newInterval = 950;
    else if (elapsed < 50) newInterval = 700;
    else newInterval = 520;

    if (state.currentSpawnMs !== newInterval) setSpawner(newInterval);
  }

  function setSpawner(ms) {
    if (state.spawnerInterval) clearInterval(state.spawnerInterval);
    state.currentSpawnMs = ms;
    state.spawnerInterval = setInterval(() => {
      if (!state.isPlaying) return;
      if (state.activeEvents.length < MAX_EVENTS_ON_SCREEN) spawnRandomEvent();
    }, ms);
  }

  function spawnRandomEvent() {
    const template = EVENTS[Math.floor(Math.random() * EVENTS.length)];
    spawnSpecificEvent(template.id, 'natural');
  }

  function spawnSpecificEvent(eventId, source = 'chain') {
    const template = EVENT_BY_ID[eventId];
    if (!template || !state.isPlaying) return;
    if (state.activeEvents.length >= MAX_EVENTS_ON_SCREEN) return;

    const top = Math.random() * 62 + 3;
    const left = Math.random() * 64 + 3;

    const eventObj = {
      uniqueId: Date.now() + Math.random(),
      ...template,
      x: left,
      y: top,
      source
    };

    state.activeEvents.push(eventObj);
    renderEventCard(eventObj);
    els.emptyMsg.classList.add('hidden');

    maybeTriggerChain(eventObj, 'onSpawn');
  }

  function maybeTriggerChain(eventObj, mode) {
    const rule = CHAIN_RULES[eventObj.id];
    if (!rule || !rule[mode]) return;
    for (const item of rule[mode]) {
      if (!state.isPlaying) return;
      if (Math.random() <= item.p) {
        const delay = Array.isArray(item.delayMs) ? randInt(item.delayMs[0], item.delayMs[1]) : item.delayMs;
        scheduleChainSpawn(item.id, delay);
      }
    }
  }

  function scheduleChainSpawn(eventId, delayMs) {
    let attempts = 0;
    const maxAttempts = 4;
    const trySpawn = () => {
      if (!state.isPlaying) return;
      if (state.activeEvents.length < MAX_EVENTS_ON_SCREEN) {
        spawnSpecificEvent(eventId, 'chain');
        return;
      }
      attempts++;
      if (attempts <= maxAttempts) setTimeout(trySpawn, 280);
    };
    setTimeout(trySpawn, delayMs);
  }

  function renderEventCard(ev) {
    const div = document.createElement('div');
    div.id = `ev-${ev.uniqueId}`;
    div.className = `event-card p-4 rounded-xl shadow-lg border-2 border-white/20 select-none ${ev.color}`;
    div.style.top = `${ev.y}%`;
    div.style.left = `${ev.x}%`;

    div.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="text-4xl shadow-sm">${ev.emoji}</span>
        <div>
          <h4 class="font-bold text-lg leading-tight">${ev.title}</h4>
          <p class="text-sm font-medium opacity-90 italic">"${ev.prompt}"</p>
        </div>
      </div>
    `;

    div.addEventListener('click', (e) => {
      e.stopPropagation();
      selectEvent(ev.uniqueId);
    });

    els.eventArea.appendChild(div);
  }

  function selectEvent(id) {
    document.querySelectorAll('.event-card').forEach(el => el.classList.remove('selected'));
    const el = document.getElementById(`ev-${id}`);
    if (el) {
      el.classList.add('selected');
      state.selectedEventId = id;
      updateButtonsState(true);
    }
  }

  els.eventArea.addEventListener('click', () => {
    document.querySelectorAll('.event-card').forEach(el => el.classList.remove('selected'));
    state.selectedEventId = null;
    updateButtonsState(false);
  });

  function updateButtonsState(hasSelection) {
    Object.values(els.btns).forEach(btn => {
      btn.disabled = !hasSelection;
      if (!hasSelection) btn.classList.add('opacity-50', 'cursor-not-allowed');
      else btn.classList.remove('opacity-50', 'cursor-not-allowed');
    });
  }

  function getMultiplier(counts) {
    if (counts === 0) return 1.0;
    if (counts === 1) return 0.7;
    if (counts === 2) return 0.4;
    return 0.2;
  }

  function updateFatigueUI(force = false) {
    const labels = { soothe: 'å®‰æ’«', explain: 'èªªæ˜', act: 'è¡Œå‹•' };

    for (const key of ['soothe','explain','act']) {
      const count = state.fatigue[key];
      const mul = getMultiplier(count);
      const pct = Math.round(mul * 100);

      // bar width (100/70/40/20)
      els.bars[key].style.width = `${pct}%`;
      els.meta[key].textContent = `æ•ˆæœ ${pct}%`;
    }

    // äººæ€§åŒ–æé†’ï¼šæŠŠã€Œè¦å›åˆ°é¡§å®¢æƒ…ç·’ã€ç”¨ä¸€å¥è©±é»é†’
    const worst = ['soothe','explain','act'].sort((a,b)=>state.fatigue[b]-state.fatigue[a])[0];
    const wCount = state.fatigue[worst];
    const wPct = Math.round(getMultiplier(wCount) * 100);

    let msg = "æç¤ºï¼šä¸‰ç¨®åšæ³•è¼ªæ›¿ï¼Œæ•ˆæœæœ€å¥½ã€‚";
    if (wCount >= 1) {
      const hint =
        worst === 'act'
          ? "ä½ ä¸€ç›´åœ¨è™•ç†äº‹æƒ…ï¼Œä½†å°æ–¹å¯èƒ½æ›´éœ€è¦è¢«ç†è§£ã€‚å…ˆæ¥ä½æƒ…ç·’ï¼Œå†åšè™•ç½®ã€‚"
          : worst === 'explain'
            ? "ä½ ä¸€ç›´åœ¨è¬›è¦å‰‡ï¼Œä½†æƒ…ç·’é‚„æ²’é™ä¸‹ä¾†ã€‚å…ˆå…±æ„Ÿï¼Œå†èªªæ˜ã€‚"
            : "ä½ ä¸€ç›´åœ¨å®‰æ’«ï¼Œä½†æœ‰äº›ç‹€æ³éœ€è¦å…·é«”èªªæ˜æˆ–è¡Œå‹•ã€‚";

      msg = `ç–²å‹æé†’ï¼šä½ é€£çºŒç”¨ã€Œ${labels[worst]}ã€ï¼Œæ•ˆæœå‰© ${wPct}%ã€‚${hint}`;
    }
    els.fatigueMsg.textContent = msg;
  }

  function handleAction(actionType) {
    if (!state.selectedEventId || !state.isPlaying) return;

    const evIndex = state.activeEvents.findIndex(e => e.uniqueId === state.selectedEventId);
    if (evIndex === -1) return;
    const event = state.activeEvents[evIndex];

    const counts = state.fatigue[actionType];
    const multiplier = getMultiplier(counts);

    for (let key in state.fatigue) {
      if (key === actionType) state.fatigue[key]++;
      else state.fatigue[key] = 0;
    }

    const impact = IMPACTS[actionType][event.type];
    const actualSat = impact[0] * multiplier;
    const actualStress = impact[1] * multiplier;

    state.satisfaction = Math.min(100, Math.max(0, state.satisfaction + actualSat));
    state.stress = Math.min(100, Math.max(0, state.stress + actualStress));
    state.resolveCount++;

    const domEl = document.getElementById(`ev-${state.selectedEventId}`);
    if(domEl) domEl.remove();
    state.activeEvents.splice(evIndex, 1);
    state.selectedEventId = null;
    updateButtonsState(false);

    maybeTriggerChain(event, 'onResolve');

    updateUI();
    updateFatigueUI();

    if(state.activeEvents.length === 0) els.emptyMsg.classList.remove('hidden');
  }

  function updateUI() {
    if ((state.satisfaction <= 0 || state.stress >= 100) && state.isPlaying) {
      state.satisfaction = Math.max(0, state.satisfaction);
      state.stress = Math.min(100, state.stress);
      endGame();
      return;
    }

    els.timer.innerText = state.time;
    if(state.time <= 15) els.timer.classList.add('text-red-500', 'shake-soft');
    else els.timer.classList.remove('text-red-500', 'shake-soft');

    els.stressVal.innerText = Math.floor(state.stress) + '%';
    els.stressBar.style.width = state.stress + '%';

    els.satVal.innerText = Math.floor(state.satisfaction);
    if(state.satisfaction > 82) els.satIcon.innerText = 'ğŸ¤©';
    else if(state.satisfaction > 55) els.satIcon.innerText = 'ğŸ™‚';
    else if(state.satisfaction > 25) els.satIcon.innerText = 'ğŸ˜°';
    else els.satIcon.innerText = 'ğŸ¤¬';

    if(state.stress > 82 || state.time < 10) document.body.classList.add('shake-hard');
    else document.body.classList.remove('shake-hard');
  }

  function endGame() {
    state.isPlaying = false;
    clearInterval(state.timerInterval);
    clearInterval(state.spawnerInterval);
    clearInterval(state.neglectInterval);
    document.body.classList.remove('shake-hard');

    document.getElementById('game-screen').classList.add('hidden');
    document.getElementById('result-screen').classList.remove('hidden');
    document.getElementById('player-name').value = '';
    document.getElementById('btn-save').disabled = false;
    document.getElementById('btn-save').innerText = "ç™»è¨˜";

    const finalSat = Math.floor(state.satisfaction);
    const finalStress = Math.floor(state.stress);
    const resolve = state.resolveCount;
    const totalScore = Math.floor((finalSat * 1.2) + (resolve * 6) - (finalStress * 1.0));

    document.getElementById('final-score').innerText = totalScore;
    document.getElementById('final-sat').innerText = finalSat;
    document.getElementById('final-stress').innerText = finalStress;
    document.getElementById('final-resolve').innerText = resolve;

    const remark = FINAL_REMARKS[Math.floor(Math.random() * FINAL_REMARKS.length)];
    document.getElementById('final-remark-1').innerText = remark.r1;
    document.getElementById('final-remark-2').innerText = remark.r2;

    setTimeout(() => {
      document.querySelectorAll('.fade-in-text').forEach(el => el.classList.add('visible'));
    }, 120);

    renderLeaderboard();
  }

  const STORAGE_KEY = 'FA_Challenge_Rank_V2';

  function getScores() {
    try { const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s) : []; }
    catch (e) { console.error("Error reading scores:", e); return []; }
  }

  function saveScore() {
    const nameInput = document.getElementById('player-name');
    const name = nameInput.value.trim() || `Player ${Math.floor(Math.random() * 999)}`;
    const score = parseInt(document.getElementById('final-score').innerText);
    const stress = parseInt(document.getElementById('final-stress').innerText);
    const resolve = parseInt(document.getElementById('final-resolve').innerText);

    const newEntry = { name, score, stress, resolve, date: Date.now() };
    let scores = getScores();
    scores.push(newEntry);

    scores.sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      if (a.stress !== b.stress) return a.stress - b.stress;
      return b.resolve - a.resolve;
    });

    scores = scores.slice(0, 5);
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(scores)); }
    catch (e) { console.error("Error saving score:", e); }

    document.getElementById('btn-save').disabled = true;
    document.getElementById('btn-save').innerText = "å·²ç™»è¨˜";
    renderLeaderboard();
  }

  function customConfirm(message, callback) { if (window.confirm(message)) callback(); }

  function renderLeaderboard() {
    const tbody = document.getElementById('leaderboard-body');
    const scores = getScores();
    tbody.innerHTML = '';
    scores.forEach((s, i) => {
      const tr = document.createElement('tr');
      tr.className = "border-b border-gray-800 text-sm";
      tr.innerHTML = `
        <td class="py-2 text-gray-500">${i + 1}</td>
        <td class="py-2 font-bold text-white">${s.name}</td>
        <td class="py-2 text-right text-yellow-400 font-mono">${s.score}</td>
        <td class="py-2 text-right text-red-400 font-mono">${s.stress}%</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function clearLeaderboard() { localStorage.removeItem(STORAGE_KEY); renderLeaderboard(); }

  // Init
  updateButtonsState(false);
  updateFatigueUI(true);
</script>
</body>
</html>
