<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è·å ´æœå‹™å¤§æŒ‘æˆ° - å–®æ©Ÿ/çµ±ä¸€æ¦œé›™æ¨¡å¼</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { font-family: system-ui, -apple-system, "Segoe UI", sans-serif; }
    body { overflow: hidden; user-select: none; }
    .app-dvh { height: 100dvh; }

    @keyframes shake {
      0% { transform: translate(1px, 1px) rotate(0deg); }
      10% { transform: translate(-1px, -2px) rotate(-1deg); }
      20% { transform: translate(-3px, 0px) rotate(1deg); }
      30% { transform: translate(3px, 2px) rotate(0deg); }
      40% { transform: translate(1px, -1px) rotate(1deg); }
      50% { transform: translate(-1px, 2px) rotate(-1deg); }
      60% { transform: translate(-3px, 1px) rotate(0deg); }
      70% { transform: translate(3px, 1px) rotate(-1deg); }
      80% { transform: translate(-1px, -1px) rotate(1deg); }
      90% { transform: translate(1px, 2px) rotate(0deg); }
      100% { transform: translate(1px, -2px) rotate(-1deg); }
    }
    .shake-hard { animation: shake 0.5s infinite; }
    .shake-soft { animation: shake 0.5s; }

    @keyframes popIn {
      0% { transform: scale(0.85); opacity: 0; }
      80% { transform: scale(1.05); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .event-card {
      animation: popIn 0.22s ease-out forwards;
      position: absolute;
      cursor: pointer;
      transition: all 0.18s;
      box-shadow: 0 10px 16px -3px rgba(0,0,0,0.14), 0 4px 8px -2px rgba(0,0,0,0.08);
      max-width: 340px;
      z-index: 10;
    }
    .event-card.selected {
      z-index: 50 !important;
      transform: scale(1.14) !important;
      border: 4px solid #3b82f6;
      box-shadow: 0 0 30px rgba(59,130,246,0.55);
    }

    .btn-action { transition: transform 0.1s; box-shadow: 0 6px 0 rgba(0,0,0,0.2); }
    .btn-action:active { transform: translateY(6px); box-shadow: 0 0 0 rgba(0,0,0,0.2); }
    .btn-action:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

    .fade-in-text { opacity: 0; transition: opacity 0.9s ease-in; }
    .visible { opacity: 1; }

    .dash-card { padding: 0.75rem; }
    .dash-number { font-size: 2.6rem; line-height: 1; }
    .dash-label { font-size: 0.75rem; }
    @media (min-width: 640px) {
      .dash-number { font-size: 3.1rem; }
      .dash-card { padding: 1rem; }
    }

    .controls-wrap { min-height: 86px; }
    .controls-title { font-size: 1.35rem; line-height: 1.05; font-weight: 900; }
    .controls-meta  { font-size: 0.9rem; line-height: 1.1; font-weight: 800; opacity: 0.95; }

    .fatigue-track { height: 7px; border-radius: 999px; background: rgba(255,255,255,0.22); }
    .fatigue-bar { height: 7px; border-radius: 999px; background: rgba(255,255,255,0.95); }

    #fatigue-msg { min-height: 1.25rem; font-weight: 900; letter-spacing: 0.2px; }

    .mobile-sticky {
      position: sticky;
      bottom: 0;
      z-index: 40;
      padding-bottom: env(safe-area-inset-bottom);
      background: linear-gradient(to top, rgba(2,6,23,0.95), rgba(2,6,23,0.65), rgba(2,6,23,0));
      backdrop-filter: blur(6px);
    }

    @media (max-width: 640px) {
      .controls-title { font-size: 1.18rem; }
      .controls-meta { font-size: 0.82rem; }
      .fatigue-track, .fatigue-bar { height: 6px; }
    }

    .pill {
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.55);
      border-radius: 999px;
      padding: 0.2rem 0.6rem;
      font-size: 0.8rem;
      color: rgba(226,232,240,0.9);
    }
  </style>
</head>

<body class="bg-slate-900 text-white min-h-screen flex flex-col">

  <!-- Start -->
  <div id="start-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 p-6">
    <h1 class="text-5xl sm:text-6xl font-black text-yellow-400 mb-3 tracking-wider text-center">è·å ´æœå‹™å¤§æŒ‘æˆ°</h1>
    <h2 class="text-2xl sm:text-3xl text-white mb-6 text-center">ç©ºæœå“¡ 60 ç§’å£“åŠ›æ¸¬è©¦</h2>

    <div class="bg-slate-800 p-6 sm:p-8 rounded-2xl shadow-2xl text-center border border-slate-700 max-w-2xl w-full">
      <div class="flex flex-wrap justify-center gap-2 mb-4">
        <span class="pill">æ™‚é–“</span>
        <span class="pill">æ»¿æ„åº¦</span>
        <span class="pill">æƒ…ç·’å£“åŠ›</span>
        <span class="pill">æŒ‰éŒ¯æˆ–ä¸æŒ‰æœƒçµæŸ</span>
      </div>

      <p class="text-gray-300 mb-6 text-base sm:text-lg leading-relaxed">
        äº‹ä»¶å¡ç‰‡æœƒä¸æ–·å‡ºç¾<br />
        å…ˆé»é¸ä¸€å¼µå¡ç‰‡ï¼Œå†æŒ‰ä¸‹æ–¹æŒ‰éˆ•è™•ç†
      </p>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <button onclick="beginPrestart('newbie')"
                class="bg-emerald-600 hover:bg-emerald-500 text-white text-2xl font-black py-5 rounded-xl shadow-lg transition transform hover:scale-[1.02]">
          æ–°æ‰‹æ¨¡å¼
        </button>
        <button onclick="beginPrestart('expert')"
                class="bg-blue-600 hover:bg-blue-500 text-white text-2xl font-black py-5 rounded-xl shadow-lg transition transform hover:scale-[1.02]">
          å°ˆå®¶æ¨¡å¼
        </button>
      </div>

      <div id="start-note" class="mt-5 text-sm text-slate-300 opacity-90 leading-relaxed">
        æ–°æ‰‹æ¨¡å¼ï¼šå–®æ©Ÿè¨ˆåˆ†ï¼Œä¸æ¯”è³½<br/>
        å°ˆå®¶æ¨¡å¼ï¼šçµ±ä¸€æ¦œè¨ˆåˆ†ï¼ˆéœ€ç¶²è·¯ï¼‰
      </div>
    </div>
  </div>

  <!-- Prestart teaching countdown -->
  <div id="prestart-overlay" class="hidden fixed inset-0 z-[60] bg-black/90 flex flex-col items-center justify-center p-8 text-center">
    <div id="prestart-tip" class="text-2xl sm:text-3xl font-black text-white mb-8 max-w-3xl"></div>
    <div id="prestart-num" class="text-8xl sm:text-9xl font-black text-yellow-300 tabular-nums">10</div>
  </div>

  <!-- Game -->
  <div id="game-screen" class="hidden flex-col w-full max-w-7xl mx-auto p-3 sm:p-4 app-dvh">
    <!-- Dashboard -->
    <div class="bg-slate-800/50 rounded-xl border border-slate-700 dash-card mb-3 sm:mb-4">
      <div class="flex items-end justify-between gap-3">
        <div class="text-center w-28 sm:w-32">
          <div class="dash-label text-gray-400 font-bold">å‰©é¤˜æ™‚é–“</div>
          <div id="timer" class="dash-number font-black text-white tabular-nums">60</div>
        </div>

        <div class="text-center w-36 sm:w-44">
          <div class="dash-label text-gray-400 font-bold">é¡§å®¢æ»¿æ„åº¦</div>
          <div class="flex items-center justify-center gap-2">
            <span id="sat-icon" class="text-3xl sm:text-4xl">ğŸ˜</span>
            <span id="sat-val" class="text-4xl sm:text-5xl font-black text-blue-400 tabular-nums">70</span>
          </div>
        </div>
      </div>

      <div class="mt-3">
        <div class="flex justify-between mb-1">
          <span class="text-xs sm:text-sm font-bold text-red-400">æƒ…ç·’å£“åŠ›</span>
          <span id="stress-val" class="text-xs sm:text-sm font-bold text-red-400">20%</span>
        </div>
        <div class="h-7 sm:h-8 bg-slate-700 rounded-full overflow-hidden border border-slate-600 relative w-full">
          <div id="stress-bar" class="h-full bg-gradient-to-r from-green-500 via-yellow-500 to-red-600 transition-all duration-200" style="width: 20%;"></div>
        </div>
      </div>

      <div id="mode-badge" class="mt-3 text-xs text-slate-300 opacity-90"></div>
    </div>

    <!-- Events -->
    <div id="event-area" class="relative flex-1 bg-slate-800/30 rounded-2xl border-2 border-dashed border-slate-600 mb-2 sm:mb-3 overflow-hidden">
      <div id="empty-msg" class="absolute inset-0 flex items-center justify-center text-slate-600 text-lg sm:text-xl font-bold pointer-events-none">
        ç­‰å¾…äº‹ä»¶ç™¼ç”Ÿ
      </div>
    </div>

    <!-- Sticky controls -->
    <div class="mobile-sticky pt-2">
      <div id="fatigue-msg" class="text-center text-orange-300 mb-2"></div>

      <div class="grid grid-cols-3 gap-3 sm:gap-6 controls-wrap">
        <button id="btn-soothe" onclick="handleAction('soothe')" class="btn-action bg-green-600 hover:bg-green-500 text-white rounded-xl flex flex-col items-center justify-center relative px-3 py-3 sm:py-4">
          <div class="controls-title">å®‰æ’«</div>
          <div class="controls-meta" id="meta-soothe">æ•ˆæœ 100%</div>
          <div class="absolute left-3 right-3 bottom-2 fatigue-track"></div>
          <div class="absolute left-3 bottom-2 fatigue-bar" id="bar-soothe" style="width:100%"></div>
        </button>

        <button id="btn-explain" onclick="handleAction('explain')" class="btn-action bg-yellow-600 hover:bg-yellow-500 text-white rounded-xl flex flex-col items-center justify-center relative px-3 py-3 sm:py-4">
          <div class="controls-title">èªªæ˜</div>
          <div class="controls-meta" id="meta-explain">æ•ˆæœ 100%</div>
          <div class="absolute left-3 right-3 bottom-2 fatigue-track"></div>
          <div class="absolute left-3 bottom-2 fatigue-bar" id="bar-explain" style="width:100%"></div>
        </button>

        <button id="btn-act" onclick="handleAction('act')" class="btn-action bg-red-600 hover:bg-red-500 text-white rounded-xl flex flex-col items-center justify-center relative px-3 py-3 sm:py-4">
          <div class="controls-title">è¡Œå‹•</div>
          <div class="controls-meta" id="meta-act">æ•ˆæœ 100%</div>
          <div class="absolute left-3 right-3 bottom-2 fatigue-track"></div>
          <div class="absolute left-3 bottom-2 fatigue-bar" id="bar-act" style="width:100%"></div>
        </button>
      </div>
    </div>
  </div>

  <!-- Result -->
  <div id="result-screen" class="hidden fixed inset-0 z-50 bg-black flex flex-col items-center justify-center p-6 sm:p-8 overflow-y-auto">
    <h2 class="text-4xl sm:text-5xl font-black text-red-500 mb-8 tracking-widest border-b-4 border-red-500 pb-2">æŒ‘æˆ°çµæŸ</h2>

    <div class="text-center mb-8 space-y-3 max-w-3xl">
      <p id="final-remark-1" class="text-xl sm:text-2xl text-white font-light fade-in-text"></p>
      <p id="final-remark-2" class="text-xl sm:text-2xl text-white font-light fade-in-text"></p>
    </div>

    <div class="flex flex-col sm:flex-row gap-6 sm:gap-8 mb-8 w-full max-w-4xl">
      <div class="flex-1 bg-gray-900 p-6 rounded-xl border border-gray-800 text-center">
        <div class="text-gray-400 text-sm uppercase">ç¸½åˆ†</div>
        <div id="final-score" class="text-6xl font-black text-yellow-400">0</div>
        <div id="final-mult" class="text-sm text-gray-400 mt-2"></div>
        <div id="final-note" class="text-xs text-slate-400 mt-2"></div>
      </div>
      <div class="flex-1 bg-gray-900 p-6 rounded-xl border border-gray-800 text-center space-y-2">
        <div class="flex justify-between border-b border-gray-800 pb-2">
          <span class="text-gray-400">é¡§å®¢æ»¿æ„åº¦</span>
          <span id="final-sat" class="text-blue-400 font-bold">0</span>
        </div>
        <div class="flex justify-between border-b border-gray-800 pb-2">
          <span class="text-gray-400">æƒ…ç·’å£“åŠ›</span>
          <span id="final-stress" class="text-red-400 font-bold">0</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-400">è§£æ±ºäº‹ä»¶æ•¸</span>
          <span id="final-resolve" class="text-green-400 font-bold">0</span>
        </div>
      </div>
    </div>

    <!-- Leaderboard (expert only) -->
    <div id="leaderboard-wrap" class="hidden w-full max-w-3xl bg-gray-900 rounded-xl p-6 border border-gray-700 mb-8">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
        <h3 class="text-xl text-yellow-400 font-bold">çµ±ä¸€æ¦œ</h3>
        <div class="flex items-center gap-2">
          <button id="btn-refresh" class="text-xs text-slate-300 hover:text-white underline" onclick="refreshLeaderboard(true)">åˆ·æ–°</button>
          <span id="lb-status" class="text-xs text-slate-400"></span>
        </div>
      </div>

      <div class="flex gap-2 mb-4">
        <input type="text" id="player-name" placeholder="è¼¸å…¥æš±ç¨±"
               class="flex-1 bg-gray-800 text-white px-4 py-2 rounded-lg border border-gray-600 focus:outline-none focus:border-blue-500" maxlength="10" />
        <button id="btn-save" onclick="saveScoreOnline()"
                class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-lg font-black">
          ç™»è¨˜
        </button>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <div class="text-sm text-slate-300 mb-2 font-bold">Top 20</div>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead>
                <tr class="text-gray-500 text-sm border-b border-gray-800">
                  <th class="pb-2">#</th>
                  <th class="pb-2">å§“å</th>
                  <th class="pb-2 text-right">åˆ†æ•¸</th>
                  <th class="pb-2 text-right">å£“åŠ›</th>
                </tr>
              </thead>
              <tbody id="top20-body"></tbody>
            </table>
          </div>
        </div>

        <div>
          <div class="text-sm text-slate-300 mb-2 font-bold">æœ€æ–° 10 ç­†</div>
          <div class="overflow-x-auto">
            <table class="w-full text-left">
              <thead>
                <tr class="text-gray-500 text-sm border-b border-gray-800">
                  <th class="pb-2">æ™‚é–“</th>
                  <th class="pb-2">å§“å</th>
                  <th class="pb-2 text-right">åˆ†æ•¸</th>
                </tr>
              </thead>
              <tbody id="latest10-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="mt-4 text-xs text-slate-400">
        ç‚ºäº†ç©©å®šï¼Œæ’è¡Œæ¦œä¸åšæ¯ç§’è‡ªå‹•åˆ·æ–°ï¼›å¯æ‰‹å‹•åˆ·æ–°æˆ–æ¯ 8 ç§’è‡ªå‹•ä¸€æ¬¡ã€‚
      </div>
    </div>

    <button onclick="location.reload()" class="text-gray-400 hover:text-white border border-gray-600 hover:border-white px-8 py-3 rounded-full transition">
      ä¸‹ä¸€ä½æŒ‘æˆ°è€…
    </button>
  </div>

<script type="module">
  /*********************
   *  Firebaseï¼ˆåªåœ¨å°ˆå®¶æ¨¡å¼ç”¨ï¼‰
   *********************/
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getDatabase, ref, push, serverTimestamp, set,
    query, orderByChild, limitToLast, get
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

  // âœ… å·²å¡«å…¥ä½ çš„ Firebase è¨­å®šï¼ˆæ¨¡çµ„ç‰ˆç”¨é€™ä»½ï¼‰
  const FIREBASE_CONFIG = {
    apiKey: "AIzaSyD6y-tPy0grqmZAUTLRKGbp5RxdmK1t7pA",
    authDomain: "selmode.firebaseapp.com",
    databaseURL: "https://selmode-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "selmode",
    appId: "1:332376582064:web:109c45e7f1d96aecdb5875"
  };

  let fb = {
    app: null,
    auth: null,
    db: null,
    user: null,
    ready: false
  };

  function isConfigReady() {
    return !!(FIREBASE_CONFIG.apiKey && FIREBASE_CONFIG.authDomain && FIREBASE_CONFIG.databaseURL && FIREBASE_CONFIG.projectId && FIREBASE_CONFIG.appId);
  }

  async function initFirebaseIfNeeded() {
    if (fb.ready) return true;
    if (!isConfigReady()) return false;
    try {
      fb.app = initializeApp(FIREBASE_CONFIG);
      fb.auth = getAuth(fb.app);
      fb.db = getDatabase(fb.app);
      const cred = await signInAnonymously(fb.auth);
      fb.user = cred.user;
      fb.ready = true;
      return true;
    } catch (e) {
      console.error("Firebase init error:", e);
      fb.ready = false;
      return false;
    }
  }

  /*********************
   *  éŠæˆ²è¨­å®š
   *********************/
  const GAME_DURATION = 60;

  const EVENTS = [
    { id: 'angry',   emoji: 'ğŸ˜ ', title: 'æ†¤æ€’å®¢è¨´',         prompt: 'æˆ‘è¦è¦‹ä½ å€‘ä¸»ç®¡ï¼',               type: 'soothe',  color: 'bg-red-500' },
    { id: 'crying',  emoji: 'ğŸ˜¢', title: 'æƒ…ç·’å´©æ½°',         prompt: 'æˆ‘çœŸçš„å¿«æ’ä¸ä½äº†â€¦',             type: 'soothe',  color: 'bg-indigo-500' },
    { id: 'panic',   emoji: 'ğŸ˜±', title: 'ææ…Œç™¼ä½œ',         prompt: 'æˆ‘å‘¼å¸ä¸åˆ°â€¦æˆ‘å¥½æ€•ï¼',           type: 'soothe',  color: 'bg-fuchsia-600' },
    { id: 'rude',    emoji: 'ğŸ˜¤', title: 'å«Œä½ è‡‰å¤ªè‡­',       prompt: 'ä½ å¯ä»¥ä¸è¦é‚£éº¼ä¸è€ç…©å—ï¼Ÿ',       type: 'soothe',  color: 'bg-rose-600' },
    { id: 'gender',  emoji: 'ğŸ™…â€â™€ï¸', title: 'æŒ‡å®šå¥³æ€§ç©ºæœå“¡',   prompt: 'æˆ‘è¦å¥³ç”Ÿä¾†æœå‹™ï¼ä½ ä¸è¡Œã€‚',       type: 'soothe',  color: 'bg-pink-600' },
    { id: 'baby',    emoji: 'ğŸ‘¶', title: 'å¬°å…’å“­é¬§',         prompt: 'å“‡å•Šå•Šå•Šï¼ï¼ï¼',                 type: 'soothe',  color: 'bg-pink-500' },

    { id: 'anxiety', emoji: 'ğŸ˜°', title: 'æ™‚é–“ç„¦æ…®',         prompt: 'è½‰æ©Ÿè¦ä¾†ä¸åŠäº†ï¼',               type: 'explain', color: 'bg-orange-500' },
    { id: 'seat',    emoji: 'ğŸ’º', title: 'è¦æ±‚æ›åº§ä½',       prompt: 'æˆ‘ä¸æƒ³åé€™è£¡ï¼Œå¹«æˆ‘æ›ï¼',         type: 'explain', color: 'bg-teal-600' },
    { id: 'narrow',  emoji: 'ğŸ“', title: 'åº§ä½å¤ªç‹¹çª„',       prompt: 'é€™ä¹Ÿå¤ªæ“ äº†å§ï¼Ÿ',                 type: 'explain', color: 'bg-cyan-700' },
    { id: 'fat',     emoji: 'ğŸ˜«', title: 'éš”å£å¤ªæ“ ',         prompt: 'éš”å£ä¸€ç›´æ“ åˆ°æˆ‘ï¼',               type: 'explain', color: 'bg-sky-700' },
    { id: 'mealbad', emoji: 'ğŸ±', title: 'é¤é»ä¸å¥½åƒ',       prompt: 'é€™å€‹ä¹Ÿå¤ªé›£åƒäº†å§ï¼Ÿ',             type: 'explain', color: 'bg-amber-700' },
    { id: 'vip',     emoji: 'ğŸ‘‘', title: 'å‡è‰™è¦æ±‚',         prompt: 'æˆ‘æ˜¯é«˜å¡æœƒå“¡ï¼Œæ‡‰è©²è¦å‡è‰™ã€‚',       type: 'explain', color: 'bg-purple-600' },

    { id: 'spill',   emoji: 'ğŸ¥¤', title: 'æ‰“ç¿»é£²æ–™',         prompt: 'å’–å•¡ç‘åœ¨æˆ‘èº«ä¸Šäº†ï¼',             type: 'act',     color: 'bg-amber-800' },
    { id: 'sick',    emoji: 'ğŸ¤¢', title: 'èº«é«”ä¸é©',         prompt: 'æˆ‘é ­å¥½æšˆâ€¦æƒ³åã€‚',               type: 'act',     color: 'bg-lime-700' },
    { id: 'blanket', emoji: 'ğŸ§£', title: 'å¤ªå†·è¦æ¯›æ¯¯',       prompt: 'æˆ‘å¿«å†·æ­»äº†ï¼Œå¿«çµ¦æˆ‘æ¯¯å­ã€‚',       type: 'act',     color: 'bg-blue-600' },
    { id: 'wifi',    emoji: 'ğŸ“¶', title: 'Wi-Fi ä¸èƒ½ç”¨',     prompt: 'ç¶²è·¯é€£ä¸ä¸Šï¼Œä½ å€‘åœ¨å¹¹å˜›ï¼Ÿ',       type: 'act',     color: 'bg-slate-600' },
    { id: 'toilet',  emoji: 'ğŸš»', title: 'å»æ‰€æ’éšŠçˆ†æ»¿',     prompt: 'æˆ‘å¿«æ†‹ä¸ä½äº†ï¼',                 type: 'act',     color: 'bg-emerald-700' },
    { id: 'headset', emoji: 'ğŸ§', title: 'è€³æ©Ÿå£äº†',         prompt: 'è€³æ©Ÿæ²’è²éŸ³ï¼Œå¹«æˆ‘è™•ç†ã€‚',         type: 'act',     color: 'bg-violet-700' }
  ];
  const EVENT_BY_ID = Object.fromEntries(EVENTS.map(e => [e.id, e]));

  // Action -> EventType : [Satisfaction Î”, Stress Î”]
  const IMPACTS = {
    soothe:  { soothe: [ 14, -10], explain: [  6,  -6], act: [  4,   0] },
    explain: { soothe: [ -6,   6], explain: [ 11,  -6], act: [  1,   4] },
    act:     { soothe: [ -6,  10], explain: [  2,   4], act: [ 14,  -5] }
  };

  const FINAL_REMARKS = [
    { r1: "ã€Œä½ åšçš„ä¸æ˜¯å°æˆ–éŒ¯ï¼Œè€Œæ˜¯èƒ½ä¸èƒ½ç©©ä½è‡ªå·±ã€‚ã€", r2: "ã€Œå…ˆè½è¦‹æƒ…ç·’ï¼Œå†åšå›æ‡‰ã€‚ã€" },
    { r1: "ã€Œå£“åŠ›ä¸€é«˜ï¼Œèªæ°£èˆ‡åˆ¤æ–·æœ€å…ˆå¤±çœŸã€‚ã€", r2: "ã€ŒæŠŠæƒ…ç·’è½‰æˆå¯åˆä½œçš„è¨Šæ¯ã€‚ã€" },
    { r1: "ã€Œæ³¨æ„åŠ›ã€æ™‚é–“ã€è€å¿ƒéƒ½æœƒè€—ã€‚ã€", r2: "ã€Œæ›ç­–ç•¥ï¼Œæ‰æ˜¯è‡ªæˆ‘èª¿ç¯€ã€‚ã€" },
    { r1: "ã€Œå…ˆæ‰¿æ¥æ„Ÿå—ï¼Œå†æ¸…æ¥šèªªç•Œç·šã€‚ã€", r2: "ã€Œç©©å®šçš„å›æ‡‰ï¼Œæ¯”è¯éº—æ›´å°ˆæ¥­ã€‚ã€" },
    { r1: "ã€Œä½ æ’ä½çš„ç¬é–“ï¼Œå°±æ˜¯è·å ´ç´ é¤Šè¢«çœ‹è¦‹ã€‚ã€", r2: "ã€Œæ›´æ—©è¦ºå¯Ÿã€æ›´å¿«é™å£“ã€æ›´æ¸…æ¥šæ±ºç­–ã€‚ã€" }
  ];

  const CHAIN_RULES = {
    gender: { onSpawn: [{ id: 'rude', p: 0.55, delayMs: [650, 1100] }, { id: 'angry', p: 0.25, delayMs: [800, 1200] }],
              onResolve: [{ id: 'angry', p: 0.20, delayMs: [650, 1100] }] },
    fat: { onResolve: [{ id: 'seat', p: 0.55, delayMs: [650, 1100] }] },
    narrow: { onResolve: [{ id: 'seat', p: 0.45, delayMs: [650, 1100] }] },
    seat: { onResolve: [{ id: 'anxiety', p: 0.35, delayMs: [650, 1050] }] },
    mealbad: { onResolve: [{ id: 'angry', p: 0.45, delayMs: [650, 1100] }] },
    wifi: { onResolve: [{ id: 'rude', p: 0.35, delayMs: [650, 1100] }] },
    spill: { onResolve: [{ id: 'angry', p: 0.35, delayMs: [650, 1100] }] },
    sick: { onResolve: [{ id: 'panic', p: 0.30, delayMs: [650, 1100] }] },
    baby: { onResolve: [{ id: 'rude', p: 0.28, delayMs: [650, 1100] }] }
  };

  const MODES = {
    newbie: { name: 'æ–°æ‰‹æ¨¡å¼', spawnMul: 2.2, maxEvents: 4, fatigueMin: 0.4, online: false },
    expert: { name: 'å°ˆå®¶æ¨¡å¼', spawnMul: 1.0, maxEvents: 6, fatigueMin: 0.2, online: true }
  };

  /*********************
   *  ç‹€æ…‹ & DOM
   *********************/
  let state = {
    modeKey: 'expert',
    mode: MODES.expert,

    time: GAME_DURATION,
    satisfaction: 70,
    stress: 20,
    resolveCount: 0,
    activeEvents: [],
    selectedEventId: null,
    fatigue: { soothe: 0, explain: 0, act: 0 },

    isPlaying: false,
    timerInterval: null,
    spawnerInterval: null,
    neglectInterval: null,
    currentSpawnMs: null,

    finalScore: 0,
    finalMult: 1.0,

    lastLbFetchAt: 0,
    lbAutoTimer: null
  };

  const els = {
    timer: document.getElementById('timer'),
    stressBar: document.getElementById('stress-bar'),
    stressVal: document.getElementById('stress-val'),
    satVal: document.getElementById('sat-val'),
    satIcon: document.getElementById('sat-icon'),
    eventArea: document.getElementById('event-area'),
    emptyMsg: document.getElementById('empty-msg'),
    fatigueMsg: document.getElementById('fatigue-msg'),

    meta: {
      soothe: document.getElementById('meta-soothe'),
      explain: document.getElementById('meta-explain'),
      act: document.getElementById('meta-act')
    },
    bars: {
      soothe: document.getElementById('bar-soothe'),
      explain: document.getElementById('bar-explain'),
      act: document.getElementById('bar-act')
    },
    btns: {
      soothe: document.getElementById('btn-soothe'),
      explain: document.getElementById('btn-explain'),
      act: document.getElementById('btn-act')
    },

    pre: {
      wrap: document.getElementById('prestart-overlay'),
      tip: document.getElementById('prestart-tip'),
      num: document.getElementById('prestart-num')
    },

    modeBadge: document.getElementById('mode-badge'),

    result: {
      wrap: document.getElementById('result-screen'),
      score: document.getElementById('final-score'),
      sat: document.getElementById('final-sat'),
      stress: document.getElementById('final-stress'),
      resolve: document.getElementById('final-resolve'),
      mult: document.getElementById('final-mult'),
      note: document.getElementById('final-note'),
      r1: document.getElementById('final-remark-1'),
      r2: document.getElementById('final-remark-2')
    },

    lb: {
      wrap: document.getElementById('leaderboard-wrap'),
      status: document.getElementById('lb-status'),
      btnSave: document.getElementById('btn-save'),
      btnRefresh: document.getElementById('btn-refresh'),
      name: document.getElementById('player-name'),
      top20: document.getElementById('top20-body'),
      latest10: document.getElementById('latest10-body')
    }
  };

  const fmtTime = (ms) => {
    const d = new Date(ms);
    const hh = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    const ss = String(d.getSeconds()).padStart(2,'0');
    return `${hh}:${mm}:${ss}`;
  };

  function randInt(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }

  /*********************
   *  é–‹å§‹å‰æ•™å­¸ï¼ˆå«å››é …ï¼‰
   *********************/
  window.beginPrestart = (modeKey) => {
    state.modeKey = modeKey;
    state.mode = MODES[modeKey];

    document.getElementById('start-screen').classList.add('hidden');
    els.pre.wrap.classList.remove('hidden');

    let t = 10;
    const tips = [
      "å…ˆé»é¸äº‹ä»¶å¡ç‰‡ï¼Œå†æŒ‰ä¸‹æ–¹æŒ‰éˆ•è™•ç†",
      "é¡§å®¢æ»¿æ„åº¦æœƒä¸‹é™ï¼šæ”¾è‘—ä¸è™•ç†æœƒæ›´å¿«ä¸‹é™",
      "æƒ…ç·’å£“åŠ›æœƒä¸Šå‡ï¼šæŒ‰éŒ¯æˆ–æ”¾è‘—ä¸è™•ç†éƒ½æœƒå‡",
      "ä»»ä¸€é …çˆ†æ‰å°±çµæŸï¼šæ»¿æ„åº¦æ­¸é›¶æˆ–å£“åŠ›çˆ†è¡¨"
    ];

    const tick = () => {
      els.pre.num.textContent = t;

      let idx = 0;
      if (t <= 9 && t >= 8) idx = 0;
      else if (t <= 7 && t >= 6) idx = 1;
      else if (t <= 5 && t >= 4) idx = 2;
      else idx = 3;

      els.pre.tip.textContent = tips[idx];

      t--;
      if (t < 0) {
        els.pre.wrap.classList.add('hidden');
        startGame();
        return;
      }
      setTimeout(tick, 1000);
    };

    tick();
  };

  /*********************
   *  éŠæˆ²ä¸»æµç¨‹
   *********************/
  function resetStateForGame() {
    state.time = GAME_DURATION;
    state.satisfaction = 70;
    state.stress = 20;
    state.resolveCount = 0;
    state.activeEvents = [];
    state.selectedEventId = null;
    state.fatigue = { soothe: 0, explain: 0, act: 0 };
    state.isPlaying = false;
    state.currentSpawnMs = null;

    clearInterval(state.timerInterval);
    clearInterval(state.spawnerInterval);
    clearInterval(state.neglectInterval);
    clearInterval(state.lbAutoTimer);

    els.eventArea.querySelectorAll('.event-card').forEach(n => n.remove());
    els.emptyMsg.classList.remove('hidden');
  }

  function startGame() {
    resetStateForGame();

    document.getElementById('game-screen').classList.remove('hidden');
    document.getElementById('game-screen').classList.add('flex');

    els.modeBadge.textContent = `${state.mode.name}ï½œäº‹ä»¶ä¸Šé™ ${state.mode.maxEvents}ï½œç–²å‹æœ€ä½ ${Math.round(state.mode.fatigueMin*100)}%`;

    state.isPlaying = true;
    updateButtonsState(false);
    updateUI();
    updateFatigueUI(true);

    state.timerInterval = setInterval(() => {
      state.time--;
      updateUI();
      updateDifficulty();
      if (state.time <= 0) endGame();
    }, 1000);

    setSpawner(Math.round(2200 * state.mode.spawnMul));

    state.neglectInterval = setInterval(() => {
      if (state.activeEvents.length > 0) {
        const satPenalty = state.activeEvents.length * 2.0;
        const stressPenalty = state.activeEvents.length * 1.0;

        state.satisfaction = Math.max(0, state.satisfaction - satPenalty);
        state.stress = Math.min(100, state.stress + stressPenalty);

        els.stressVal.classList.add('shake-soft');
        setTimeout(() => els.stressVal.classList.remove('shake-soft'), 180);

        updateUI();
      }
    }, 1000);
  }

  function updateDifficulty() {
    if (!state.isPlaying) return;

    const elapsed = GAME_DURATION - state.time;
    let base;

    if (elapsed < 10) base = 1900;
    else if (elapsed < 20) base = 1500;
    else if (elapsed < 30) base = 1150;
    else if (elapsed < 40) base = 900;
    else if (elapsed < 50) base = 680;
    else base = 520;

    const newInterval = Math.round(base * state.mode.spawnMul);
    if (state.currentSpawnMs !== newInterval) setSpawner(newInterval);
  }

  function setSpawner(ms) {
    if (state.spawnerInterval) clearInterval(state.spawnerInterval);
    state.currentSpawnMs = ms;
    state.spawnerInterval = setInterval(() => {
      if (!state.isPlaying) return;
      if (state.activeEvents.length < state.mode.maxEvents) spawnRandomEvent();
    }, ms);
  }

  function spawnRandomEvent() {
    const template = EVENTS[Math.floor(Math.random() * EVENTS.length)];
    spawnSpecificEvent(template.id, 'natural');
  }

  function spawnSpecificEvent(eventId, source = 'chain') {
    const template = EVENT_BY_ID[eventId];
    if (!template || !state.isPlaying) return;
    if (state.activeEvents.length >= state.mode.maxEvents) return;

    const top = Math.random() * 62 + 3;
    const left = Math.random() * 64 + 3;

    const eventObj = {
      uniqueId: Date.now() + Math.random(),
      ...template,
      x: left,
      y: top,
      source
    };

    state.activeEvents.push(eventObj);
    renderEventCard(eventObj);
    els.emptyMsg.classList.add('hidden');

    maybeTriggerChain(eventObj, 'onSpawn');
  }

  function maybeTriggerChain(eventObj, mode) {
    const rule = CHAIN_RULES[eventObj.id];
    if (!rule || !rule[mode]) return;
    for (const item of rule[mode]) {
      if (!state.isPlaying) return;
      if (Math.random() <= item.p) {
        const delay = Array.isArray(item.delayMs) ? randInt(item.delayMs[0], item.delayMs[1]) : item.delayMs;
        scheduleChainSpawn(item.id, delay);
      }
    }
  }

  function scheduleChainSpawn(eventId, delayMs) {
    let attempts = 0;
    const maxAttempts = 4;
    const trySpawn = () => {
      if (!state.isPlaying) return;
      if (state.activeEvents.length < state.mode.maxEvents) {
        spawnSpecificEvent(eventId, 'chain');
        return;
      }
      attempts++;
      if (attempts <= maxAttempts) setTimeout(trySpawn, 280);
    };
    setTimeout(trySpawn, delayMs);
  }

  function renderEventCard(ev) {
    const div = document.createElement('div');
    div.id = `ev-${ev.uniqueId}`;
    div.className = `event-card p-4 rounded-xl shadow-lg border-2 border-white/20 select-none ${ev.color}`;
    div.style.top = `${ev.y}%`;
    div.style.left = `${ev.x}%`;

    div.innerHTML = `
      <div class="flex items-center gap-3">
        <span class="text-4xl">${ev.emoji}</span>
        <div>
          <h4 class="font-black text-lg leading-tight">${ev.title}</h4>
          <p class="text-sm font-semibold opacity-90 italic">"${ev.prompt}"</p>
        </div>
      </div>
    `;

    div.addEventListener('click', (e) => {
      e.stopPropagation();
      selectEvent(ev.uniqueId);
    });

    els.eventArea.appendChild(div);
  }

  function selectEvent(id) {
    document.querySelectorAll('.event-card').forEach(el => el.classList.remove('selected'));
    const el = document.getElementById(`ev-${id}`);
    if (el) {
      el.classList.add('selected');
      state.selectedEventId = id;
      updateButtonsState(true);
    }
  }

  els.eventArea.addEventListener('click', () => {
    document.querySelectorAll('.event-card').forEach(el => el.classList.remove('selected'));
    state.selectedEventId = null;
    updateButtonsState(false);
  });

  function updateButtonsState(hasSelection) {
    Object.values(els.btns).forEach(btn => {
      btn.disabled = !hasSelection;
      if (!hasSelection) btn.classList.add('opacity-50', 'cursor-not-allowed');
      else btn.classList.remove('opacity-50', 'cursor-not-allowed');
    });
  }

  function getMultiplier(counts) {
    if (counts === 0) return 1.0;
    if (counts === 1) return 0.7;
    if (counts === 2) return 0.4;
    return state.mode.fatigueMin;
  }

  function updateFatigueUI() {
    const labels = { soothe: 'å®‰æ’«', explain: 'èªªæ˜', act: 'è¡Œå‹•' };

    for (const key of ['soothe','explain','act']) {
      const count = state.fatigue[key];
      const mul = getMultiplier(count);
      const pct = Math.round(mul * 100);
      els.bars[key].style.width = `${pct}%`;
      els.meta[key].textContent = `æ•ˆæœ ${pct}%`;
    }

    const worst = ['soothe','explain','act'].sort((a,b)=>state.fatigue[b]-state.fatigue[a])[0];
    const wCount = state.fatigue[worst];
    const wPct = Math.round(getMultiplier(wCount) * 100);

    let msg = "è¼ªæ›¿ä½¿ç”¨ä¸‰ç¨®åšæ³•ï¼Œæ•ˆæœæœ€å¥½";
    if (wCount >= 1) {
      const hint =
        worst === 'act'
          ? "å…ˆæ¥ä½æƒ…ç·’ï¼Œå†åšè™•ç½®"
          : worst === 'explain'
            ? "å…ˆå…±æ„Ÿï¼Œå†èªªæ˜"
            : "éœ€è¦æ™‚ä¹Ÿè¦èªªæ˜æˆ–è¡Œå‹•";
      msg = `ä½ é€£çºŒç”¨ã€Œ${labels[worst]}ã€æ•ˆæœå‰© ${wPct}%ã€€${hint}`;
    }
    els.fatigueMsg.textContent = msg;
  }

  window.handleAction = (actionType) => {
    if (!state.selectedEventId || !state.isPlaying) return;

    const evIndex = state.activeEvents.findIndex(e => e.uniqueId === state.selectedEventId);
    if (evIndex === -1) return;
    const event = state.activeEvents[evIndex];

    const counts = state.fatigue[actionType];
    const multiplier = getMultiplier(counts);

    for (let key in state.fatigue) {
      if (key === actionType) state.fatigue[key]++;
      else state.fatigue[key] = 0;
    }

    const impact = IMPACTS[actionType][event.type];
    const actualSat = impact[0] * multiplier;
    const actualStress = impact[1] * multiplier;

    state.satisfaction = Math.min(100, Math.max(0, state.satisfaction + actualSat));
    state.stress = Math.min(100, Math.max(0, state.stress + actualStress));
    state.resolveCount++;

    const domEl = document.getElementById(`ev-${state.selectedEventId}`);
    if (domEl) domEl.remove();
    state.activeEvents.splice(evIndex, 1);
    state.selectedEventId = null;
    updateButtonsState(false);

    maybeTriggerChain(event, 'onResolve');

    updateUI();
    updateFatigueUI();

    if (state.activeEvents.length === 0) els.emptyMsg.classList.remove('hidden');
  };

  function updateUI() {
    if ((state.satisfaction <= 0 || state.stress >= 100) && state.isPlaying) {
      state.satisfaction = Math.max(0, state.satisfaction);
      state.stress = Math.min(100, state.stress);
      endGame();
      return;
    }

    els.timer.innerText = state.time;
    if (state.time <= 15) els.timer.classList.add('text-red-500', 'shake-soft');
    else els.timer.classList.remove('text-red-500', 'shake-soft');

    els.stressVal.innerText = Math.floor(state.stress) + '%';
    els.stressBar.style.width = state.stress + '%';

    els.satVal.innerText = Math.floor(state.satisfaction);
    if (state.satisfaction > 82) els.satIcon.innerText = 'ğŸ¤©';
    else if (state.satisfaction > 55) els.satIcon.innerText = 'ğŸ™‚';
    else if (state.satisfaction > 25) els.satIcon.innerText = 'ğŸ˜°';
    else els.satIcon.innerText = 'ğŸ¤¬';

    if (state.stress > 82 || state.time < 10) document.body.classList.add('shake-hard');
    else document.body.classList.remove('shake-hard');
  }

  function endGame() {
    state.isPlaying = false;
    clearInterval(state.timerInterval);
    clearInterval(state.spawnerInterval);
    clearInterval(state.neglectInterval);
    document.body.classList.remove('shake-hard');

    els.eventArea.querySelectorAll('.event-card').forEach(n => n.remove());

    document.getElementById('game-screen').classList.add('hidden');
    els.result.wrap.classList.remove('hidden');

    const finalSat = Math.floor(state.satisfaction);
    const finalStress = Math.floor(state.stress);
    const resolve = state.resolveCount;

    const base = resolve * 100;
    const bonus = finalSat * 5;
    const mult = 1 + ((100 - finalStress) / 200); // 1.0 ~ 1.5
    const totalScore = Math.floor((base + bonus) * mult);

    state.finalScore = totalScore;
    state.finalMult = mult;

    els.result.score.textContent = totalScore;
    els.result.sat.textContent = finalSat;
    els.result.stress.textContent = finalStress;
    els.result.resolve.textContent = resolve;
    els.result.mult.textContent = `å€ç‡ x ${mult.toFixed(2)}`;

    const remark = FINAL_REMARKS[Math.floor(Math.random() * FINAL_REMARKS.length)];
    els.result.r1.textContent = remark.r1;
    els.result.r2.textContent = remark.r2;

    setTimeout(() => {
      document.querySelectorAll('.fade-in-text').forEach(el => el.classList.add('visible'));
    }, 120);

    if (state.mode.online) {
      els.result.note.textContent = "å°ˆå®¶æ¨¡å¼ï¼šå¯ç™»è¨˜åˆ°çµ±ä¸€æ¦œ";
      els.lb.wrap.classList.remove('hidden');
      els.lb.name.value = '';
      els.lb.btnSave.disabled = false;
      els.lb.btnSave.textContent = "ç™»è¨˜";
      els.lb.status.textContent = isConfigReady() ? "" : "Firebase æœªè¨­å®š";

      (async () => {
        const ok = await initFirebaseIfNeeded();
        if (!ok) {
          els.lb.status.textContent = "Firebase åˆå§‹åŒ–å¤±æ•—";
          els.lb.btnSave.disabled = true;
          return;
        }
        els.lb.status.textContent = "å·²é€£ç·š";
        await refreshLeaderboard(true);
        clearInterval(state.lbAutoTimer);
        state.lbAutoTimer = setInterval(() => refreshLeaderboard(false), 8000);
      })();

    } else {
      els.result.note.textContent = "æ–°æ‰‹æ¨¡å¼ï¼šå–®æ©Ÿè¨ˆåˆ†ï¼Œä¸æ¯”è³½";
      els.lb.wrap.classList.add('hidden');
    }
  }

  /*********************
   *  çµ±ä¸€æ¦œï¼šå¯«å…¥/è®€å–ï¼ˆå°ˆå®¶æ¨¡å¼ï¼‰
   *********************/
  window.saveScoreOnline = async () => {
    if (!state.mode.online) return;

    els.lb.btnSave.disabled = true;
    els.lb.btnSave.textContent = "é€å‡ºä¸­â€¦";

    const nameRaw = (els.lb.name.value || "").trim();
    const name = nameRaw ? nameRaw.slice(0, 10) : `Player${Math.floor(Math.random()*999)}`;

    const payload = {
      name,
      score: state.finalScore,
      stress: Math.floor(state.stress),
      satisfaction: Math.floor(state.satisfaction),
      resolve: state.resolveCount,
      mult: Number(state.finalMult.toFixed(2)),
      createdAt: Date.now(),
      serverTime: serverTimestamp()
    };

    try {
      const ok = await initFirebaseIfNeeded();
      if (!ok) throw new Error("Firebase init failed");

      const listRef = ref(fb.db, "scores");
      const newRef = push(listRef);
      await set(newRef, payload);

      els.lb.btnSave.textContent = "å·²ç™»è¨˜";
      els.lb.status.textContent = "ç™»è¨˜æˆåŠŸ";
      await refreshLeaderboard(true);

    } catch (e) {
      console.error(e);
      els.lb.btnSave.disabled = false;
      els.lb.btnSave.textContent = "é‡é€";
      els.lb.status.textContent = "é€å‡ºå¤±æ•—ï¼Œå¯é‡é€";
    }
  };

  window.refreshLeaderboard = async (force = false) => {
    if (!state.mode.online) return;

    const now = Date.now();
    if (!force && now - state.lastLbFetchAt < 4500) return;
    state.lastLbFetchAt = now;

    els.lb.status.textContent = "æ›´æ–°ä¸­â€¦";

    try {
      const ok = await initFirebaseIfNeeded();
      if (!ok) throw new Error("Firebase init failed");

      const qTop = query(ref(fb.db, "scores"), orderByChild("score"), limitToLast(20));
      const topSnap = await get(qTop);
      const topArr = [];
      topSnap.forEach(ch => topArr.push({ key: ch.key, ...ch.val() }));
      topArr.sort((a,b) => (b.score - a.score) || (a.stress - b.stress) || ((b.resolve||0) - (a.resolve||0)));

      const qLatest = query(ref(fb.db, "scores"), orderByChild("createdAt"), limitToLast(10));
      const latestSnap = await get(qLatest);
      const latestArr = [];
      latestSnap.forEach(ch => latestArr.push({ key: ch.key, ...ch.val() }));
      latestArr.sort((a,b) => (b.createdAt - a.createdAt));

      renderTop20(topArr);
      renderLatest10(latestArr);

      els.lb.status.textContent = `æ›´æ–° ${fmtTime(Date.now())}`;
    } catch (e) {
      console.error(e);
      els.lb.status.textContent = "æ›´æ–°å¤±æ•—";
    }
  };

  function renderTop20(items) {
    els.lb.top20.innerHTML = "";
    items.forEach((s, i) => {
      const tr = document.createElement("tr");
      tr.className = "border-b border-gray-800 text-sm";
      tr.innerHTML = `
        <td class="py-2 text-gray-500">${i+1}</td>
        <td class="py-2 font-bold text-white">${escapeHtml(s.name || "â€”")}</td>
        <td class="py-2 text-right text-yellow-400 font-mono">${Number(s.score||0)}</td>
        <td class="py-2 text-right text-red-400 font-mono">${Number(s.stress||0)}%</td>
      `;
      els.lb.top20.appendChild(tr);
    });
  }

  function renderLatest10(items) {
    els.lb.latest10.innerHTML = "";
    items.forEach((s) => {
      const tr = document.createElement("tr");
      tr.className = "border-b border-gray-800 text-sm";
      tr.innerHTML = `
        <td class="py-2 text-gray-500 font-mono">${fmtTime(s.createdAt || Date.now())}</td>
        <td class="py-2 font-bold text-white">${escapeHtml(s.name || "â€”")}</td>
        <td class="py-2 text-right text-yellow-400 font-mono">${Number(s.score||0)}</td>
      `;
      els.lb.latest10.appendChild(tr);
    });
  }

  function escapeHtml(str) {
    return String(str).replace(/[&<>"']/g, (c) => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'
    }[c]));
  }

  function updateButtonsState(hasSelection) {
    Object.values(els.btns).forEach(btn => {
      btn.disabled = !hasSelection;
      if (!hasSelection) btn.classList.add('opacity-50', 'cursor-not-allowed');
      else btn.classList.remove('opacity-50', 'cursor-not-allowed');
    });
  }

  updateButtonsState(false);
  updateFatigueUI(true);
</script>

</body>
</html>
